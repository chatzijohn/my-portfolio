# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased] - 2025-12-22

### Summary of Changes

This release contains a significant architectural refactoring to improve the **Separation of Concerns** within the application. The primary goal was to move all database-related logic, especially transaction management, out of the `service` layer and into the `repository` layer. This makes the codebase cleaner, more modular, and easier to test.

### Added

-   **`Querier` Interface (`internal/db/querier.go`)**: Introduced a new interface to abstract the database queries generated by `sqlc`.
    -   **Why**: This decouples the repository layer from the concrete `sqlc` implementation. It allows for easier unit testing of the repositories by enabling the use of mock `Querier` implementations, removing the need for a live database connection during tests.

-   **Centralized Transaction Logic (`internal/repository/repository.go`)**: Added a generic `execTx` function to provide a consistent, reusable way to execute code within a database transaction.
    -   **Why**: This reduces code duplication and ensures that transaction handling (begin, commit, rollback) is managed uniformly across all repositories.

### Changed

-   **Transaction Management Moved to Repository**: The responsibility for creating and managing database transactions was moved entirely from the `WaterSupplyService` to the `WaterSupplyRepository`.
    -   **Why**: This was the core objective of the refactoring. The `service` layer should only contain business logic and remain agnostic of database details. The `repository` layer's single responsibility is to handle all data persistence and database communication.

-   **Repository Logic for `ImportWaterSupplies`**: The business logic for importing supplies (checking if a record exists, then either inserting or updating) now resides within the `WaterSupplyRepository`, executed inside a single transaction.
    -   **Why**: This co-locates the business operation with its corresponding database logic, making the flow of data easier to trace and ensuring data consistency by performing the check-then-act operation atomically.

-   **Updated Dependency Injection**: The entire application startup chain (from `main.go` through `service.go`) was refactored. The `pgxpool.Pool` is now passed to the repository layer, and the repositories are passed (as interfaces) to the service layer.
    -   **Why**: To provide each layer with only the dependencies it needs, enforcing the new architectural boundaries.

### Fixed

-   **Corrected Compile-Time Errors**: Fixed a series of compilation errors present in the original code and introduced during the refactoring. This included:
    -   Fixing a critical bug where a repository was being passed where a service dependency was expected.
    -   Resolving numerous type mismatches between handlers, services, and repositories.
    -   Ensuring the `Querier` interface precisely matched the methods and types generated by `sqlc`.

### Removed

-   **Database Dependencies from Service Layer**: Removed all direct dependencies on `pgx` and the `sqlc`-generated `*db.Queries` from the service files.
    -   **Why**: To strictly enforce that the service layer is not aware of the database implementation details, fulfilling the goal of true separation of concerns.
